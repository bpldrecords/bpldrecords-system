<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BPLD Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* Same CSS as your original dashboard */
* { box-sizing: border-box; margin:0; padding:0; font-family:'Roboto', sans-serif; }
body { background:#f4f7fc; padding:20px; }
.navbar { width:100%; background:#093d75; color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; border-radius:10px; flex-wrap:wrap; }
.navbar h2 { font-weight:500; font-size:18px; }
.navbar button { background:#dc3545; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; color:white; transition:0.3s; }
.navbar button:hover{ background:#a71d2a; }
.dashboard-top { display:flex; justify-content:space-between; align-items:center; margin-top:20px; flex-wrap:wrap; gap:15px; }
.dashboard-top .welcome, .dashboard-top .receiving { background:white; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
.dashboard-top .receiving { text-align:center; transition:0.3s; cursor:pointer; }
.dashboard-top .receiving:hover { transform:translateY(-3px); box-shadow:0 12px 25px rgba(0,0,0,0.15); }
.dashboard-top button { background:#007bff; color:white; border:none; border-radius:8px; padding:12px; cursor:pointer; width:100%; font-size:16px; transition:0.3s; }
.dashboard-top button:hover{ background:#0056b3; }
.dashboard-info { margin-top:20px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:15px; }
.dashboard-info div { background:white; padding:15px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
.table-container { margin-top:30px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; border-radius:8px; background:white; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
th, td { padding:12px; border-bottom:1px solid #e0e0e0; text-align:left; }
thead{ background:#093d75; color:white; }
tr.pending { background:#fff3cd; cursor:pointer; transition:0.2s; }
tr.pending:hover { background:#ffe8a1; }
.modal-container { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-container > div { background:white; padding:25px; border-radius:16px; width:90%; max-width:400px; box-shadow:0 12px 25px rgba(0,0,0,0.2); }
.modal-container input, .modal-container textarea, .modal-container select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; }
.modal-container button { width:48%; padding:12px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
.modal-container button[type="submit"]{ background:#093d75; color:white; }
.modal-container button[type="button"]{ background:#dc3545; color:white; }
</style>
</head>
<body>

<div class="navbar">
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="bpldlogo.png" alt="Logo" style="width:40px; height:40px;">
    <h2>BUSINESS PERMIT AND LICENSE DEPARTMENT</h2>
    <h3>DASHBOARD</h3>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<div class="dashboard-top">
  <div class="welcome">
    <h3>Welcome, <span id="name"></span> (<span id="branch"></span>)</h3>
  </div>
  <div class="receiving">
    <button onclick="openReceivingForm()">Receiving Form</button>
  </div>
</div>

<div class="dashboard-info">
  <div>
    <h3>Total Pending: <span id="totalPending">0</span></h3>
  </div>
  <div>
    <h3>DATE AS OF: <span id="todayDate"></span></h3>
  </div>
</div>

<div class="table-container">
  <h3>PENDING TRANSACTION</h3>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>NAME</th>
        <th>DESCRIPTION</th>
        <th>TRANSACTION</th>
        <th>DATE IN</th>
        <th>TIME IN</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Release Modal -->
<div id="releaseFormContainer" class="modal-container">
  <div>
    <form id="releaseForm">
      <input type="hidden" id="recordId">
      <label>NAME</label>
      <input type="text" id="nameField" readonly>
      <label>DESCRIPTION</label>
      <input type="text" id="descField" readonly>
      <label>TRANSACTION</label>
      <input type="text" id="transField" readonly>
      <label>STATUS</label>
      <select id="statusField" required>
        <option value="PENDING">PENDING</option>
        <option value="HOLD">HOLD</option>
        <option value="TRANSFER">TRANSFER</option>
        <option value="FINISHED">FINISHED</option>
        <option value="CANCEL">CANCEL</option>
      </select>
      <label>RELEASED BY</label>
      <input type="text" id="releasedBy" required>
      <label>REMARKS</label>
      <textarea id="remarks"></textarea>
      <div style="display:flex; justify-content:space-between;">
        <button type="submit">Release</button>
        <button type="button" onclick="closeReleaseForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Receiving Modal -->
<div id="receivingFormContainer" class="modal-container">
  <div>
    <form id="receivingForm">
      <label>NAME</label>
      <input type="text" id="recName" required>
      <label>DESCRIPTION</label>
      <input type="text" id="recDesc">
      <label>TRANSACTION</label>
      <select id="recTrans" required>
        <option value="">Select Transaction</option>
        <option value="NEW">NEW</option>
        <option value="RENEWAL">RENEWAL</option>
        <option value="AMENDMENT">AMENDMENT</option>
        <option value="RETIREMENT">RETIREMENT</option>
        <option value="OTHERS">OTHERS</option>
      </select>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button type="submit">Submit</button>
        <button type="button" onclick="closeReceivingForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = window.supabase.createClient(
  'https://tbfxfnbkmpwmahpdrcke.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiZnhmbmJrbXB3bWFocGRyY2tlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzAxNDQsImV4cCI6MjA3NjU0NjE0NH0.7lGTqu310YMMgYIaDsSPt3pwk_505JMEccBJ_F8Xbi8'
);

const fullname = localStorage.getItem("fullname");
const branchName = localStorage.getItem("branch");

if (!fullname || !branchName) window.location.href = "index.html";
document.getElementById("name").innerText = fullname.toUpperCase();
document.getElementById("branch").innerText = branchName.toUpperCase();

/* ===== Load Pending Transactions ===== */
async function loadPending() {
  try {
    const phNow = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }));

    // Display current date/time on dashboard header
    document.getElementById("todayDate").innerText = phNow.toLocaleString("en-PH", {
      month: "2-digit", day: "2-digit", year: "numeric",
      hour: "2-digit", minute: "2-digit", hour12: true
    });

    // Fetch pending transactions
   const { data, error } = await supabase
  .from('pending_transactions')
  .select('*')
  .eq('branch', branchName)
  .eq('status', 'PENDING')  // <-- only show pending
  .order('authonumber', { ascending: false });


    if (error) throw error;

    const tbody = document.querySelector("#pendingTable tbody");
    tbody.innerHTML = "";

    if (data.length > 0) {
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "pending";

        // Convert time_in (HH:MM:SS) to 12-hour format
        let displayTime = '';
        if (r.time_in) {
          const [hourStr, minuteStr] = r.time_in.split(':');
          let hour = parseInt(hourStr, 10);
          const minutes = minuteStr;
          const ampm = hour >= 12 ? 'PM' : 'AM';
          hour = ((hour + 11) % 12 + 1);
          displayTime = `${hour}:${minutes} ${ampm}`;
        }

        tr.innerHTML = `
          <td>${r.authonumber || ''}</td>
          <td>${(r.name || '').toUpperCase()}</td>
          <td>${(r.description || '').toUpperCase()}</td>
          <td>${(r.transaction || '').toUpperCase()}</td>
          <td>${r.date_in || ''}</td>
          <td>${displayTime}</td>
        `;

        tr.addEventListener("click", () => openReleaseForm(r));
        tbody.appendChild(tr);
      });
      document.getElementById("totalPending").innerText = data.length;
    } else {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">NO PENDING TRANSACTIONS</td></tr>`;
      document.getElementById("totalPending").innerText = 0;
    }

  } catch (err) {
    console.error("❌ Error loading pending transactions:", err);
    alert("Failed to load pending transactions. Check console for details.");
  }
}

/* ===== Receiving Form Logic ===== */
document.getElementById("receivingForm").addEventListener("submit", async e => {
  e.preventDefault();
  const name = document.getElementById("recName").value.trim();
  const description = document.getElementById("recDesc").value.trim();
  const transaction = document.getElementById("recTrans").value;

  const phTime = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }));
  const currentDate = phTime.toISOString().split('T')[0];
  const hours = phTime.getHours();
  const minutes = phTime.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const formattedHours = ((hours + 11) % 12 + 1);
  const currentTime = `${formattedHours}:${minutes} ${ampm}`;

  try {
    const { data, error } = await supabase
      .from('pending_transactions')
      .insert([{
        name,
        description,
        transaction,
        branch: branchName,
        received_by: fullname,
        date_in: currentDate,
        time_in: currentTime,
        status: 'PENDING'
      }])
      .select();

    if (error) throw error;

    closeReceivingForm();
    document.getElementById("receivingForm").reset();
    loadPending();
  } catch (err) {
    console.error(err);
    alert("❌ Error adding transaction: " + err.message);
  }
});

/* ===== Release Form Logic ===== */
function openReleaseForm(record) {
  const modal = document.getElementById("releaseFormContainer");
  modal.style.display = "flex";
  document.getElementById("recordId").value = record.authonumber; // use authonumber instead of id
  document.getElementById("nameField").value = record.name.toUpperCase();
  document.getElementById("descField").value = record.description.toUpperCase();
  document.getElementById("transField").value = record.transaction.toUpperCase();
  document.getElementById("statusField").value = record.status?.toUpperCase() || "PENDING";
  document.getElementById("releasedBy").value = fullname.toUpperCase();
  document.getElementById("remarks").value = record.remarks?.toUpperCase() || "";
}

function closeReleaseForm() {
  document.getElementById("releaseFormContainer").style.display = "none";
  document.getElementById("releaseForm").reset();
}

document.getElementById("releaseForm").addEventListener("submit", async e => {
  e.preventDefault();

  const authonumber = document.getElementById("recordId").value;
  const releasedBy = document.getElementById("releasedBy").value;
  const remarks = document.getElementById("remarks").value;
  const status = document.getElementById("statusField").value;

  // ✅ Define dateOut and timeOut BEFORE updating
  const phTime = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }));
  const dateOut = phTime.toISOString().split('T')[0]; // YYYY-MM-DD
  const hours = phTime.getHours();
  const minutes = phTime.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const formattedHours = ((hours + 11) % 12 + 1); // 12-hour format
  const timeOut = `${formattedHours}:${minutes} ${ampm}`;

  try {
    const { data, error } = await supabase
      .from('pending_transactions')
      .update({
        status,
        released_by: releasedBy,
        remarks,
        date_out: dateOut,
        time_out: timeOut
      })
      .eq('authonumber', authonumber);

    if (error) throw error;

    alert(`✅ TRANSACTION ${status.toUpperCase()} SUCCESSFULLY!`);
    closeReleaseForm();
    loadPending();
  } catch (err) {
    console.error(err);
    alert("❌ Error releasing transaction: " + err.message);
  }
});

/* ===== Modal Controls ===== */
function openReceivingForm() {
  document.getElementById("receivingFormContainer").style.display = "flex";
}
function closeReceivingForm() {
  document.getElementById("receivingFormContainer").style.display = "none";
  document.getElementById("receivingForm").reset();
}

/* ===== Initial Load ===== */
loadPending();

</script>
</body>
</html>
